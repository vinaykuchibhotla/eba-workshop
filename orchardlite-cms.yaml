AWSTemplateFormatVersion: "2010-09-09"
Description: "OrchardLite CMS - AWS Modernization Workshop Demo (Ready to Deploy - No Parameters Required)"

Parameters:
  DBUsername:
    Type: String
    Default: orchardadmin
    Description: Database administrator username

  DBPassword:
    Type: String
    NoEcho: true
    Default: OrchardPassword2024!
    MinLength: 8
    Description: Database administrator password

  AppDBUsername:
    Type: String
    Default: orchardapp
    Description: Application database username

  AppDBPassword:
    Type: String
    NoEcho: true
    Default: AppPassword2024!
    MinLength: 8
    Description: Application database password

  MyIPAddress:
    Type: String
    Default: 0.0.0.0/0
    Description: Your IP address for secure access (CIDR format, e.g., 1.2.3.4/32)
    AllowedPattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$

Resources:
  # VPC and Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-IGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-Public-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-Public-2

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-Public-RT

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Route Table Associations
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # Security Groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer (restricted to your IP)
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref MyIPAddress
          Description: HTTP access from your IP only
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-ALB-SG

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ECS tasks (restricted to your IP)
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP access from ALB only
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: !Ref MyIPAddress
          Description: Direct HTTP access from your IP (for testing)
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-ECS-SG

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS MySQL database (restricted access)
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref ECSSecurityGroup
          Description: MySQL access from ECS tasks only
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref MyIPAddress
          Description: MySQL access from your IP (for admin/testing)
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-Database-SG

  # Database Subnet Group (using public subnets - insecure by design)
  DatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for OrchardLite RDS database (PUBLIC - INSECURE)
      SubnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-SubnetGroup

  # RDS MySQL Database
  RDSDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    CreationPolicy:
      ResourceSignal:
        Timeout: PT8M
    Properties:
      DBInstanceIdentifier: orchardlite-mysql-enterprise
      DBInstanceClass: db.t3.micro
      Engine: mysql
      EngineVersion: "8.0.39"
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      AllocatedStorage: 20
      StorageType: gp2
      StorageEncrypted: true
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DatabaseSubnetGroup
      BackupRetentionPeriod: 7
      MultiAZ: false
      PubliclyAccessible: true
      DeletionProtection: false
      Tags:
        - Key: Name
          Value: OrchardLite-MySQL-Enterprise

  # IAM Roles
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: OrchardLite-Enterprise-ALB
      Scheme: internet-facing
      Type: application
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: OrchardLite-Enterprise-ALB

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: OrchardLite-Enterprise-TG
      Port: 8080
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: ip
      HealthCheckPath: /health
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 15
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

  # ECS Cluster
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: OrchardLite-Enterprise-Cluster
      CapacityProviders:
        - FARGATE
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1

  # CloudWatch Log Group
  ECSLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/orchardlite-prestage
      RetentionInDays: 7

  # ECS Task Definition
  ECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DependsOn: RDSDatabase
    Properties:
      Family: orchardlite-prestage-task
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: 512
      Memory: 1024
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: orchardlite-prestage-app
          Image: public.ecr.aws/docker/library/node:18-alpine
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: DB_HOST
              Value: !GetAtt RDSDatabase.Endpoint.Address
            - Name: DB_PORT
              Value: !GetAtt RDSDatabase.Endpoint.Port
            - Name: DB_USER
              Value: !Ref AppDBUsername
            - Name: DB_PASSWORD
              Value: !Ref AppDBPassword
            - Name: DB_ADMIN_USER
              Value: !Ref DBUsername
            - Name: DB_ADMIN_PASSWORD
              Value: !Ref DBPassword
            - Name: DB_NAME
              Value: OrchardLiteDB
            - Name: DOTNET_VERSION
              Value: "Framework 4.8"
            - Name: DEPLOYMENT_TYPE
              Value: "CloudFormation Automated"
            - Name: PHASE
              Value: "Phase 1 - Current State"
          Command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache mysql-client curl
              cat > package.json << 'EOF'
              {
                "name": "orchardlite-prestage",
                "version": "1.0.0",
                "description": "OrchardLite CMS - Enterprise Application",
                "main": "server.js",
                "scripts": {
                  "start": "node server.js"
                },
                "dependencies": {
                  "express": "^4.18.2",
                  "mysql2": "^3.6.0"
                }
              }
              EOF

              # Create problematic license files for scanning detection
              cat > LICENSE-GPL << 'EOF'
              GNU GENERAL PUBLIC LICENSE
              Version 3, 29 June 2007

              This program is free software: you can redistribute it and/or modify
              it under the terms of the GNU General Public License as published by
              the Free Software Foundation, either version 3 of the License, or
              (at your option) any later version.

              This program contains GPL-licensed components that may require
              source code disclosure under copyleft terms.
              EOF

              cat > THIRD-PARTY-LICENSES << 'EOF'
              This software includes the following third-party components:

              1. gpl-licensed-package v1.0.0 - GNU GPL v3.0
              2. copyleft-dependency v2.1.0 - GNU AGPL v3.0  
              3. agpl-component v1.5.0 - GNU Affero GPL v3.0

              These components may have licensing restrictions that require
              compliance review and potential source code disclosure.
              EOF

              npm install --no-optional --timeout=60000 || echo "npm install completed with warnings"
              cat > server.js << 'EOF'
              const express = require('express');
              const mysql = require('mysql2/promise');
              const app = express();
              const serverPort = 8080;

              const dbConfig = {
                host: process.env.DB_HOST,
                port: process.env.DB_PORT || 3306,
                user: process.env.DB_USER,
                password: process.env.DB_PASSWORD,
                database: process.env.DB_NAME
              };

              console.log('Starting OrchardLite CMS - Enterprise Application');
              console.log('Database Host:', dbConfig.host);

              // Initialize database on startup
              async function initializeDatabase() {
                try {
                  console.log('Initializing database...');
                  const adminConnection = await mysql.createConnection({
                    host: dbConfig.host,
                    port: dbConfig.port,
                    user: process.env.DB_ADMIN_USER,
                    password: process.env.DB_ADMIN_PASSWORD
                  });
                  
                  // Create database and user
                  await adminConnection.execute('CREATE DATABASE IF NOT EXISTS OrchardLiteDB');
                  await adminConnection.execute(`CREATE USER IF NOT EXISTS '${process.env.DB_USER}'@'%' IDENTIFIED BY '${process.env.DB_PASSWORD}'`);
                  await adminConnection.execute(`GRANT ALL PRIVILEGES ON OrchardLiteDB.* TO '${process.env.DB_USER}'@'%'`);
                  await adminConnection.execute('FLUSH PRIVILEGES');
                  await adminConnection.end();
                  
                  // Connect to the database
                  const dbConnection = await mysql.createConnection(dbConfig);
                  
                  // Create tables
                  await dbConnection.execute(`
                    CREATE TABLE IF NOT EXISTS ContentItems (
                      Id INT AUTO_INCREMENT PRIMARY KEY,
                      Title VARCHAR(255) NOT NULL,
                      Summary TEXT,
                      Body LONGTEXT,
                      ContentType VARCHAR(50) NOT NULL DEFAULT 'BlogPost',
                      AuthorId INT,
                      PublishedDate DATETIME NOT NULL,
                      ViewCount INT DEFAULT 0,
                      IsPublished BOOLEAN DEFAULT TRUE,
                      CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
                      INDEX idx_published_date (PublishedDate),
                      INDEX idx_content_type (ContentType)
                    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
                  `);
                  
                  // Check if we have data
                  const [rows] = await dbConnection.execute('SELECT COUNT(*) as count FROM ContentItems');
                  if (rows[0].count === 0) {
                    const totalRecords = 100;
                    console.log(`Seeding initial data (${totalRecords} records for migration demo)...`);
                    
                    // Base sample data with historic dates
                    const baseSampleData = [
                      ['Welcome to OrchardLite CMS', 'Getting started with our enterprise CMS application', 'This is a sample blog post showcasing our enterprise content management system. The application is running on ECS Fargate with RDS MySQL.', 'BlogPost', 1, new Date('2019-12-15'), 42],
                      ['Infrastructure Deployment Complete', 'Cloud infrastructure successfully deployed', 'The infrastructure deployment includes ECS Fargate, RDS MySQL, and Application Load Balancer. Ready for modernization planning.', 'BlogPost', 1, new Date('2019-11-20'), 28],
                      ['Enterprise Content Management', 'Powerful CMS for modern applications', 'OrchardLite CMS provides enterprise-grade content management capabilities with scalable cloud architecture.', 'BlogPost', 1, new Date('2019-10-10'), 15]
                    ];
                    
                    // Generate additional realistic content for migration demo
                    const topics = [
                      'AWS Migration', 'Database Migration', 'Cloud Architecture', 'DevOps Practices', 
                      'Containerization', 'Microservices', 'Security Best Practices', 'Cost Optimization',
                      'Monitoring and Logging', 'Disaster Recovery', 'Performance Tuning', 'Compliance',
                      'Infrastructure as Code', 'CI/CD Pipelines', 'Serverless Computing', 'Data Analytics'
                    ];
                    
                    const contentTypes = ['BlogPost', 'Page', 'Article', 'Tutorial'];
                    
                    // Insert base data
                    for (const item of baseSampleData) {
                      await dbConnection.execute(
                        'INSERT INTO ContentItems (Title, Summary, Body, ContentType, AuthorId, PublishedDate, ViewCount) VALUES (?, ?, ?, ?, ?, ?, ?)',
                        item
                      );
                    }
                    
                    // Generate 97 additional records (total 100)
                    for (let i = 4; i <= 100; i++) {
                      const topic = topics[Math.floor(Math.random() * topics.length)];
                      const contentType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
                      const viewCount = Math.floor(Math.random() * 200) + 1;
                      const authorId = Math.floor(Math.random() * 3) + 1; // Authors 1-3
                      
                      // Create historic date between 2017-2019
                      const startYear = 2017;
                      const endYear = 2019;
                      const year = startYear + Math.floor(Math.random() * (endYear - startYear + 1));
                      const month = Math.floor(Math.random() * 12);
                      const day = Math.floor(Math.random() * 28) + 1;
                      const publishDate = new Date(year, month, day);
                      
                      const title = `${topic} Guide ${i}`;
                      const summary = `Comprehensive guide covering ${topic.toLowerCase()} best practices and implementation strategies for enterprise applications.`;
                      const body = `<h1>${title}</h1><p>This ${contentType.toLowerCase()} provides detailed insights into ${topic.toLowerCase()} for modern cloud architectures.</p><h2>Key Benefits</h2><ul><li>Improved scalability and performance</li><li>Enhanced security and compliance</li><li>Cost-effective solutions</li><li>Streamlined operations</li></ul><h2>Implementation Strategy</h2><p>Our approach focuses on practical implementation with real-world examples and best practices. This content demonstrates the complexity and richness of data that will be migrated using AWS DMS.</p><p>Content ID: ${i} | Generated for migration workshop demonstration.</p>`;
                      
                      await dbConnection.execute(
                        'INSERT INTO ContentItems (Title, Summary, Body, ContentType, AuthorId, PublishedDate, ViewCount) VALUES (?, ?, ?, ?, ?, ?, ?)',
                        [title, summary, body, contentType, authorId, publishDate, viewCount]
                      );
                    }
                    
                    console.log('Sample data inserted successfully (100 records)');
                  }
                  
                  await dbConnection.end();
                  console.log('Database initialization complete');
                } catch (error) {
                  console.error('Database initialization error:', error);
                }
              }

              app.get('/health', (req, res) => {
                res.json({ 
                  status: 'OK', 
                  phase: process.env.PHASE || 'Phase 1 - Current State',
                  dotnetVersion: process.env.DOTNET_VERSION || '.NET Framework 4.8',
                  deploymentType: process.env.DEPLOYMENT_TYPE || 'CloudFormation Automated',
                  databaseType: 'RDS MySQL 8.0',
                  databaseHost: dbConfig.host,
                  timestamp: new Date().toISOString()
                });
              });

              // View all content items (for migration demo)
              app.get('/all-content', async (req, res) => {
                try {
                  const connection = await mysql.createConnection(dbConfig);
                  
                  // Get all content items
                  const [allPosts] = await connection.execute('SELECT * FROM ContentItems ORDER BY PublishedDate DESC');
                  const totalRecords = allPosts.length;
                  
                  await connection.end();
                  
                  res.send(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>All Content - OrchardLite CMS</title>
                      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                    </head>
                    <body>
                      <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #232F3E;">
                        <div class="container">
                          <a class="navbar-brand text-white" href="/"><i class="fas fa-leaf" style="color: #FF9900;"></i> OrchardLite CMS</a>
                          <div class="navbar-nav ms-auto">
                            <a class="nav-link text-white" href="/"><i class="fas fa-home"></i> Home</a>
                            <span class="badge bg-danger me-2"><i class="fas fa-code"></i> .NET Framework 4.8</span>
                            <span class="badge bg-danger"><i class="fas fa-database"></i> RDS MySQL 8.0</span>
                          </div>
                        </div>
                      </nav>
                      
                      <div class="container mt-4">
                        <div class="alert" style="background-color: #E8F4FD; border-color: #FF9900; color: #232F3E;">
                          <h4><i class="fas fa-list" style="color: #FF9900;"></i> All Content Items (${totalRecords} records)</h4>
                          <p class="mb-0">Complete list of content items for AWS DMS migration demonstration.</p>
                        </div>
                        
                        <div class="row">
                          ${allPosts.map((post, index) => 
                            `<div class="col-md-4 mb-3">
                              <div class="card h-100">
                                <div class="card-body">
                                  <h6 class="card-title">${post.Title}</h6>
                                  <p class="card-text small">${post.Summary || 'No summary available'}</p>
                                  <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                      <i class="fas fa-calendar"></i> ${new Date(post.PublishedDate).toLocaleDateString()}
                                    </small>
                                    <small class="text-muted">
                                      <span class="badge bg-secondary">${post.ContentType}</span>
                                      <i class="fas fa-eye ms-1"></i> ${post.ViewCount}
                                    </small>
                                  </div>
                                </div>
                              </div>
                            </div>`
                          ).join('')}
                        </div>
                        
                        <div class="mt-4 text-center">
                          <a href="/" class="btn" style="background-color: #232F3E; border-color: #232F3E; color: white;"><i class="fas fa-arrow-left"></i> Back to Home</a>
                        </div>
                      </div>
                      
                      <footer class="mt-5 py-3" style="background-color: #F2F3F3;">
                        <div class="container text-center">
                          <small class="text-muted">
                            OrchardLite CMS - Migration Demo | 
                            <i class="fas fa-database"></i> ${totalRecords} Total Records | 
                            <i class="fas fa-server"></i> Ready for AWS DMS
                          </small>
                        </div>
                      </footer>
                    </body>
                    </html>
                  `);
                } catch (error) {
                  console.error('Error fetching all content:', error);
                  res.status(500).send(`
                    <div class="container mt-4">
                      <div class="alert alert-danger">
                        <h1><i class="fas fa-exclamation-triangle"></i> Error Loading Content</h1>
                        <p><strong>Error:</strong> ${error.message}</p>
                      </div>
                    </div>
                  `);
                }
              });

              app.get('/', async (req, res) => {
                try {
                  const connection = await mysql.createConnection(dbConfig);
                  
                  // Get total record count
                  const [countResult] = await connection.execute('SELECT COUNT(*) as total FROM ContentItems');
                  const totalRecords = countResult[0].total;
                  
                  // Get recent posts (show more for migration demo)
                  const [posts] = await connection.execute('SELECT * FROM ContentItems ORDER BY PublishedDate DESC LIMIT 20');
                  
                  await connection.end();
                  
                  // Dynamic Environment Analysis System
                  const analysisResults = {
                    dotnetVersion: { status: 'unknown', issues: [], display: 'Unknown' },
                    database: { status: 'unknown', issues: [], display: 'Unknown' },
                    network: { status: 'unknown', issues: [], display: 'Unknown' },
                    licenses: { status: 'unknown', issues: [], display: 'Unknown' },
                    security: { status: 'unknown', issues: [], display: 'Unknown' }
                  };
                  
                  try {
                    // 1. .NET Version Detection (AWS Transform integration ready)
                    const dotnetVersion = process.env.DOTNET_VERSION || 'Framework 4.8';
                    const buildInfo = process.env.BUILD_INFO || '';
                    const transformStatus = process.env.TRANSFORM_STATUS || '';
                    
                    if (dotnetVersion.includes('Framework 4.8') || dotnetVersion.includes('4.8')) {
                      analysisResults.dotnetVersion = {
                        status: 'legacy',
                        issues: ['Legacy .NET Framework 4.8', 'End-of-life approaching', 'Security vulnerabilities', 'Not cloud-optimized'],
                        display: '<span class="text-danger">.NET Framework 4.8</span>',
                        recommendation: 'Upgrade to .NET 8 using AWS Transform'
                      };
                    } else if (dotnetVersion.includes('8.0') || dotnetVersion.includes('8')) {
                      analysisResults.dotnetVersion = {
                        status: 'modern',
                        issues: [],
                        display: '<span class="text-success">.NET 8.0</span>',
                        recommendation: 'Modern framework - optimized for cloud'
                      };
                    } else if (dotnetVersion.includes('Core') || dotnetVersion.includes('6.0') || dotnetVersion.includes('7.0')) {
                      analysisResults.dotnetVersion = {
                        status: 'transitional',
                        issues: ['Consider upgrading to .NET 8 LTS'],
                        display: '<span class="text-warning">' + dotnetVersion + '</span>',
                        recommendation: 'Upgrade to .NET 8 for latest features'
                      };
                    }
                    
                    // 2. Database Detection (DMS + Aurora migration ready)
                    const dbType = process.env.DATABASE_TYPE || 'RDS MySQL 8.0';
                    const dbHost = process.env.DB_HOST || '';
                    const dbEngine = process.env.DB_ENGINE || 'mysql';
                    const isPubliclyAccessible = process.env.DB_PUBLIC_ACCESS || 'true';
                    
                    if (dbHost.includes('cluster') && dbEngine.includes('aurora')) {
                      // Aurora cluster detected (after migration)
                      analysisResults.database = {
                        status: 'modern',
                        issues: [],
                        display: '<span class="text-success">Aurora MySQL (Serverless)</span>',
                        recommendation: 'Modern managed database service'
                      };
                    } else if (dbHost.includes('rds') && dbType.includes('MySQL')) {
                      // Legacy RDS MySQL (current state)
                      const issues = ['Single-instance database', 'No read replicas'];
                      if (isPubliclyAccessible === 'true') {
                        issues.push('Database in public subnet', 'Publicly accessible', 'Direct internet access');
                      }
                      analysisResults.database = {
                        status: 'legacy',
                        issues: issues,
                        display: '<span class="text-danger">RDS MySQL 8.0 (Public)</span>',
                        recommendation: 'Migrate to Aurora using AWS DMS'
                      };
                    }
                    
                    // 3. Network Configuration Detection (Platform team improvements ready)
                    const hasPrivateSubnets = process.env.PRIVATE_SUBNET_ID ? true : false;
                    const hasNATGateway = process.env.NAT_GATEWAY_ID ? true : false;
                    const hasVPCEndpoints = process.env.VPC_ENDPOINTS ? true : false;
                    const subnetType = process.env.SUBNET_TYPE || 'public';
                    if (hasPrivateSubnets && hasNATGateway && hasVPCEndpoints) {
                      analysisResults.network = {
                        status: 'secure',
                        issues: [],
                        display: '<span class="text-success">Private Subnets + VPC Endpoints</span>',
                        recommendation: 'Secure network architecture implemented'
                      };
                    } else if (hasPrivateSubnets && hasNATGateway) {
                      analysisResults.network = {
                        status: 'improved',
                        issues: ['Consider VPC endpoints for AWS services'],
                        display: '<span class="text-warning">Private Subnets with NAT</span>',
                        recommendation: 'Add VPC endpoints for better security'
                      };
                    } else {
                      analysisResults.network = {
                        status: 'insecure',
                        issues: ['All resources in public subnets', 'No private network isolation', 'Direct internet exposure', 'Database publicly accessible'],
                        display: '<span class="text-danger">Public Subnets Only</span>',
                        recommendation: 'Implement private subnets and NAT Gateway'
                      };
                    }
                    
                    // 4. License Detection (check for problematic license files)
                    const fs = require('fs');
                    let licenseIssues = [];
                    try {
                      // Check if problematic license files exist
                      if (fs.existsSync('./LICENSE-GPL')) {
                        licenseIssues.push('GPL-licensed components detected');
                      }
                      if (fs.existsSync('./THIRD-PARTY-LICENSES')) {
                        licenseIssues.push('Third-party license restrictions');
                      }
                      
                      // Always add some license issues for demo purposes since we created the files
                      if (licenseIssues.length === 0) {
                        licenseIssues.push('GPL license file found');
                        licenseIssues.push('AGPL components identified');
                        licenseIssues.push('Copyleft restrictions apply');
                      }
                      
                    } catch (e) {
                      console.log('License detection error:', e.message);
                      // Fallback license issues for demo
                      licenseIssues.push('License compliance check failed');
                    }
                    
                    if (licenseIssues.length > 0) {
                      analysisResults.licenses = {
                        status: 'violation',
                        issues: licenseIssues,
                        display: '<span class="text-danger">License Issues Detected</span>'
                      };
                    } else {
                      analysisResults.licenses = {
                        status: 'compliant',
                        issues: [],
                        display: '<span class="text-success">Compliant</span>'
                      };
                    }
                    
                    // 5. Deployment Pipeline Detection (DevOps team progress)
                    const deploymentMethod = process.env.DEPLOYMENT_METHOD || 'manual';
                    const pipelineStatus = process.env.PIPELINE_STATUS || '';
                    const codeQuality = process.env.CODE_QUALITY_GATES || '';
                    if (deploymentMethod === 'pipeline' && pipelineStatus === 'active') {
                      analysisResults.deployment = {
                        status: 'automated',
                        issues: [],
                        display: '<span class="text-success">CI/CD Pipeline Active</span>',
                        recommendation: 'Automated deployments with quality gates'
                      };
                    } else if (deploymentMethod === 'codedeploy') {
                      analysisResults.deployment = {
                        status: 'semi-automated',
                        issues: ['Consider full CI/CD pipeline'],
                        display: '<span class="text-warning">CodeDeploy Integration</span>',
                        recommendation: 'Implement full CI/CD with CodePipeline'
                      };
                    } else {
                      analysisResults.deployment = {
                        status: 'manual',
                        issues: ['Manual deployments', 'No automated testing', 'Risk of human error'],
                        display: '<span class="text-danger">Manual CloudFormation</span>',
                        recommendation: 'Implement CI/CD pipeline with CodePipeline'
                      };
                    }
                    // 6. Overall Security Assessment
                    const allIssues = [
                      ...analysisResults.dotnetVersion.issues,
                      ...analysisResults.database.issues,
                      ...analysisResults.network.issues,
                      ...analysisResults.licenses.issues,
                      ...analysisResults.deployment.issues
                    ];
                    
                    analysisResults.security = {
                      status: allIssues.length > 0 ? 'critical' : 'good',
                      issues: allIssues,
                      display: allIssues.length > 0 ? 
                        `<span class="text-danger">${allIssues.length} Issues Found</span>` :
                        '<span class="text-success">No Issues</span>'
                    };
                    
                  } catch (error) {
                    console.log('Environment analysis error:', error);
                  }
                  
                  res.send(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>OrchardLite CMS - Enterprise Content Management</title>
                      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                    </head>
                    <body>
                      <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #232F3E;">
                        <div class="container">
                          <a class="navbar-brand text-white" href="/"><i class="fas fa-leaf" style="color: #FF9900;"></i> OrchardLite CMS</a>
                          <div class="navbar-nav ms-auto">
                            <span class="badge bg-danger me-2"><i class="fas fa-code"></i> .NET Framework 4.8</span>
                            <span class="badge bg-danger"><i class="fas fa-database"></i> RDS MySQL 8.0</span>
                          </div>
                        </div>
                      </nav>
                      
                      <div class="container mt-4">

                        
                        <div class="alert alert-warning">
                          <h5><i class="fas fa-exclamation-triangle text-warning"></i> License Compliance Warning</h5>
                          <p class="mb-0"><strong>Notice:</strong> This application contains GPL and AGPL licensed components that may require source code disclosure. <strong>Compliance review recommended before production deployment.</strong></p>
                        </div>
                        
                        <div class="alert alert-danger">
                          <h5><i class="fas fa-shield-alt text-danger"></i> Network Security Warning</h5>
                          <p class="mb-0"><strong>Critical:</strong> Database and application deployed in <strong>public subnets with direct internet access</strong>. This configuration violates security best practices and requires immediate network isolation.</p>
                        </div>
                        
                        <div class="row">
                          <div class="col-md-8">
                            <h1>Welcome to OrchardLite CMS</h1>
                            <p class="lead">Enterprise Content Management System</p>
                            
                            <div class="alert alert-success">
                              <h5><i class="fas fa-check-circle"></i> Database Connected</h5>
                              <p><strong>Database:</strong> ${dbConfig.host}:${dbConfig.port}</p>
                              <p><strong>Total Records:</strong> ${totalRecords}</p>
                              <p><strong>Platform:</strong> ECS Fargate</p>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                              <h3>Content Items</h3>
                              <a href="/all-content" class="btn btn-sm" style="background-color: #FF9900; border-color: #FF9900; color: white;">
                                <i class="fas fa-list"></i> View All ${totalRecords} Records
                              </a>
                            </div>
                            <div class="row">
                              ${posts.map((post, index) => 
                                `<div class="col-md-6 mb-3">
                                  <div class="card">
                                    <div class="card-body">
                                      <h6 class="card-title">${post.Title}</h6>
                                      <p class="card-text small">${post.Summary || 'No summary available'}</p>
                                      <small class="text-muted">
                                        <i class="fas fa-calendar"></i> ${new Date(post.PublishedDate).toLocaleDateString()}
                                        <i class="fas fa-eye ms-2"></i> ${post.ViewCount}
                                      </small>
                                    </div>
                                  </div>
                                </div>`
                              ).join('')}
                            </div>
                            <div class="text-center mt-3">
                              <small class="text-muted">Showing latest 20 of ${totalRecords} total records</small>
                            </div>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="card">
                              <div class="card-header text-white" style="background-color: #232F3E;">
                                <h5><i class="fas fa-info-circle" style="color: #FF9900;"></i> System Information</h5>
                              </div>
                              <div class="card-body">
                                <ul class="list-unstyled">
                                  <li><strong>Framework:</strong> ${analysisResults.dotnetVersion.display}</li>
                                  <li><strong>Platform:</strong> ECS Fargate</li>
                                  <li><strong>Database:</strong> ${analysisResults.database.display}</li>
                                  <li><strong>Network:</strong> ${analysisResults.network.display}</li>
                                  <li><strong>Licenses:</strong> ${analysisResults.licenses.display}</li>
                                  <li><strong>Deployment:</strong> ${analysisResults.deployment.display}</li>
                                  <li><strong>Security:</strong> ${analysisResults.security.display}</li>
                                  <li><strong>Records:</strong> ${totalRecords}</li>
                                </ul>
                              </div>
                            </div>
                            
                            ${analysisResults.security.issues.length > 0 ? `
                            <div class="card mt-3">
                              <div class="card-header text-white" style="background-color: #dc3545;">
                                <h5><i class="fas fa-exclamation-triangle"></i> Issues Detected (${analysisResults.security.issues.length})</h5>
                              </div>
                              <div class="card-body">
                                <div class="alert alert-danger" style="margin-bottom: 10px;">
                                  <small><i class="fas fa-exclamation-triangle"></i> <strong>Environment Analysis Results</strong></small>
                                </div>
                                <ul class="list-unstyled small">
                                  ${analysisResults.security.issues.map(issue => `<li><i class="fas fa-times text-danger"></i> ${issue}</li>`).join('')}
                                  <li><small class="text-muted">Modernization required</small></li>
                                </ul>
                              </div>
                            </div>` : `
                            <div class="card mt-3">
                              <div class="card-header text-white" style="background-color: #28a745;">
                                <h5><i class="fas fa-check-circle"></i> Environment Secure</h5>
                              </div>
                              <div class="card-body">
                                <p class="text-success mb-0"><i class="fas fa-shield-alt"></i> No security issues detected</p>
                              </div>
                            </div>`}
                            
                            <div class="card mt-3">
                              <div class="card-header text-white" style="background-color: #dc3545;">
                                <h5><i class="fas fa-exclamation-triangle"></i> License Compliance</h5>
                              </div>
                              <div class="card-body">
                                <div class="alert alert-warning" style="margin-bottom: 10px;">
                                  <small><i class="fas fa-exclamation-circle"></i> <strong>License Issues Detected</strong></small>
                                </div>
                                <ul class="list-unstyled small">
                                  <li><i class="fas fa-times text-danger"></i> GPL-licensed components</li>
                                  <li><i class="fas fa-times text-danger"></i> AGPL dependencies found</li>
                                  <li><i class="fas fa-times text-danger"></i> Copyleft restrictions</li>
                                  <li><small class="text-muted">Requires compliance review</small></li>
                                </ul>
                              </div>
                            </div>
                            
                            <div class="card mt-3">
                              <div class="card-header text-white" style="background-color: #FF9900;">
                                <h5><i class="fas fa-check-circle"></i> Setup Complete</h5>
                              </div>
                              <div class="card-body">
                                <ul class="list-unstyled">
                                  <li><i class="fas fa-check text-success"></i> RDS MySQL Database</li>
                                  <li><i class="fas fa-check text-success"></i> ECS Fargate Application</li>
                                  <li><i class="fas fa-check text-success"></i> Load Balancer & Networking</li>
                                  <li><i class="fas fa-check text-success"></i> Sample Data Created</li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <footer class="mt-5 py-3" style="background-color: #F2F3F3;">
                        <div class="container text-center">
                          <small class="text-muted">
                            OrchardLite CMS - Enterprise Content Management | 
                            <i class="fas fa-code"></i> <span class="text-danger">.NET Framework 4.8</span> | 
                            <i class="fas fa-database"></i> <span class="text-danger">RDS MySQL 8.0</span> | 
                            <i class="fas fa-server"></i> ${totalRecords} Records
                          </small>
                        </div>
                      </footer>
                    </body>
                    </html>
                  `);
                } catch (error) {
                  console.error('Database error:', error);
                  res.status(500).send(`
                    <div class="container mt-4">
                      <div class="alert alert-danger">
                        <h1><i class="fas fa-exclamation-triangle"></i> Database Connection Error</h1>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Database Host:</strong> ${dbConfig.host}</p>
                        <p><strong>Phase:</strong> ${process.env.PHASE}</p>
                      </div>
                    </div>
                  `);
                }
              });

              // Initialize database and start server
              initializeDatabase().then(() => {
                app.listen(serverPort, '0.0.0.0', () => {
                  console.log(`OrchardLite CMS Enterprise (.NET Framework 4.8) running on port ${serverPort}`);
                  console.log('Database Host:', dbConfig.host);
                  console.log('Application Deployment Complete');
                });
              }).catch(error => {
                console.error('Failed to initialize database:', error);
                process.exit(1);
              });
              EOF
              npm start
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref ECSLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  # ECS Service
  ECSService:
    Type: AWS::ECS::Service
    DependsOn: ALBListener
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT10M
    Properties:
      ServiceName: orchardlite-prestage-service
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref ECSTaskDefinition
      LaunchType: FARGATE
      DesiredCount: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !Ref ECSSecurityGroup
          Subnets:
            - !Ref PublicSubnet1
            - !Ref PublicSubnet2
          AssignPublicIp: ENABLED
      LoadBalancers:
        - ContainerName: orchardlite-prestage-app
          ContainerPort: 8080
          TargetGroupArn: !Ref ALBTargetGroup
      HealthCheckGracePeriodSeconds: 180
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 0
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true

Outputs:
  ApplicationURL:
    Description: "OrchardLite CMS Application - Click to access your deployed application"
    Value: !Sub "http://${ApplicationLoadBalancer.DNSName}"
