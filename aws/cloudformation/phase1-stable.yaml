AWSTemplateFormatVersion: "2010-09-09"
Description: "OrchardLite CMS - Phase 1 Prestage: ECS + RDS MySQL (Simplified and Reliable)"

Parameters:
  DBUsername:
    Type: String
    Default: orchardadmin
    Description: Database administrator username

  DBPassword:
    Type: String
    NoEcho: true
    Default: OrchardPassword2024!
    MinLength: 8
    Description: Database administrator password

  AppDBUsername:
    Type: String
    Default: orchardapp
    Description: Application database username

  AppDBPassword:
    Type: String
    NoEcho: true
    Default: AppPassword2024!
    MinLength: 8
    Description: Application database password

Resources:
  # VPC and Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-VPC

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-IGW

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Public-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Public-2

  # Private Subnets
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Private-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Private-2

  # Database Subnets
  DatabaseSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.5.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Database-1

  DatabaseSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.6.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Database-2

  # NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Public-RT

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Private-RT

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  # Route Table Associations
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # Security Groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP access
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-ALB-SG

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ECS tasks
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 10.0.1.0/24
          Description: HTTP access from public subnet 1
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 10.0.2.0/24
          Description: HTTP access from public subnet 2
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-ECS-SG

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS MySQL database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.0.0.0/16
          Description: MySQL access from VPC
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-Database-SG

  # Database Subnet Group
  DatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for OrchardLite RDS database
      SubnetIds:
        - !Ref DatabaseSubnet1
        - !Ref DatabaseSubnet2
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-SubnetGroup

  # RDS MySQL Database
  RDSDatabase:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    Properties:
      DBInstanceIdentifier: orchardlite-mysql-prestage
      DBInstanceClass: db.t3.micro
      Engine: mysql
      EngineVersion: "8.0.39"
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      AllocatedStorage: 20
      StorageType: gp2
      StorageEncrypted: true
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DatabaseSubnetGroup
      BackupRetentionPeriod: 7
      MultiAZ: false
      PubliclyAccessible: false
      DeletionProtection: false
      Tags:
        - Key: Name
          Value: OrchardLite-MySQL-Prestage

  # IAM Roles
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: OrchardLite-Prestage-ALB
      Scheme: internet-facing
      Type: application
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Tags:
        - Key: Name
          Value: OrchardLite-Prestage-ALB

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: OrchardLite-Prestage-TG
      Port: 8080
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: ip
      HealthCheckPath: /health
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

  # ECS Cluster
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: OrchardLite-Prestage-Cluster
      CapacityProviders:
        - FARGATE
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1

  # CloudWatch Log Group
  ECSLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/orchardlite-prestage
      RetentionInDays: 7

  # ECS Task Definition
  ECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DependsOn: RDSDatabase
    Properties:
      Family: orchardlite-prestage-task
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: 512
      Memory: 1024
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: orchardlite-prestage-app
          Image: public.ecr.aws/docker/library/node:18-alpine
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          Environment:
            - Name: DB_HOST
              Value: !GetAtt RDSDatabase.Endpoint.Address
            - Name: DB_PORT
              Value: !GetAtt RDSDatabase.Endpoint.Port
            - Name: DB_USER
              Value: !Ref AppDBUsername
            - Name: DB_PASSWORD
              Value: !Ref AppDBPassword
            - Name: DB_ADMIN_USER
              Value: !Ref DBUsername
            - Name: DB_ADMIN_PASSWORD
              Value: !Ref DBPassword
            - Name: DB_NAME
              Value: OrchardLiteDB
            - Name: DOTNET_VERSION
              Value: "Framework 4.8"
            - Name: DEPLOYMENT_TYPE
              Value: "CloudFormation Automated"
            - Name: PHASE
              Value: "Phase 1 - Current State"
          Command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache mysql-client curl
              cat > package.json << 'EOF'
              {
                "name": "orchardlite-prestage",
                "version": "1.0.0",
                "description": "OrchardLite CMS - Enterprise Application",
                "main": "server.js",
                "scripts": {
                  "start": "node server.js"
                },
                "dependencies": {
                  "express": "^4.18.2",
                  "mysql2": "^3.6.0"
                }
              }
              EOF
              npm install
              cat > server.js << 'EOF'
              const express = require('express');
              const mysql = require('mysql2/promise');
              const app = express();
              const serverPort = 8080;

              const dbConfig = {
                host: process.env.DB_HOST,
                port: process.env.DB_PORT || 3306,
                user: process.env.DB_USER,
                password: process.env.DB_PASSWORD,
                database: process.env.DB_NAME
              };

              console.log('Starting OrchardLite CMS - Enterprise Application');
              console.log('Database Host:', dbConfig.host);

              // Initialize database on startup
              async function initializeDatabase() {
                try {
                  console.log('Initializing database...');
                  const adminConnection = await mysql.createConnection({
                    host: dbConfig.host,
                    port: dbConfig.port,
                    user: process.env.DB_ADMIN_USER,
                    password: process.env.DB_ADMIN_PASSWORD
                  });
                  
                  // Create database and user
                  await adminConnection.execute('CREATE DATABASE IF NOT EXISTS OrchardLiteDB');
                  await adminConnection.execute(`CREATE USER IF NOT EXISTS '${process.env.DB_USER}'@'%' IDENTIFIED BY '${process.env.DB_PASSWORD}'`);
                  await adminConnection.execute(`GRANT ALL PRIVILEGES ON OrchardLiteDB.* TO '${process.env.DB_USER}'@'%'`);
                  await adminConnection.execute('FLUSH PRIVILEGES');
                  await adminConnection.end();
                  
                  // Connect to the database
                  const dbConnection = await mysql.createConnection(dbConfig);
                  
                  // Create tables
                  await dbConnection.execute(`
                    CREATE TABLE IF NOT EXISTS ContentItems (
                      Id INT AUTO_INCREMENT PRIMARY KEY,
                      Title VARCHAR(255) NOT NULL,
                      Summary TEXT,
                      Body LONGTEXT,
                      ContentType VARCHAR(50) NOT NULL DEFAULT 'BlogPost',
                      AuthorId INT,
                      PublishedDate DATETIME NOT NULL,
                      ViewCount INT DEFAULT 0,
                      IsPublished BOOLEAN DEFAULT TRUE,
                      CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
                      INDEX idx_published_date (PublishedDate),
                      INDEX idx_content_type (ContentType)
                    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
                  `);
                  
                  // Check if we have data
                  const [rows] = await dbConnection.execute('SELECT COUNT(*) as count FROM ContentItems');
                  if (rows[0].count === 0) {
                    console.log('Seeding initial data (100 records for migration demo)...');
                    
                    // Base sample data with historic dates
                    const baseSampleData = [
                      ['Welcome to OrchardLite CMS', 'Getting started with our enterprise CMS application', 'This is a sample blog post showcasing our enterprise content management system. The application is running on ECS Fargate with RDS MySQL.', 'BlogPost', 1, new Date('2019-12-15'), 42],
                      ['Infrastructure Deployment Complete', 'Cloud infrastructure successfully deployed', 'The infrastructure deployment includes ECS Fargate, RDS MySQL, and Application Load Balancer. Ready for modernization planning.', 'BlogPost', 1, new Date('2019-11-20'), 28],
                      ['Enterprise Content Management', 'Powerful CMS for modern applications', 'OrchardLite CMS provides enterprise-grade content management capabilities with scalable cloud architecture.', 'BlogPost', 1, new Date('2019-10-10'), 15]
                    ];
                    
                    // Generate additional realistic content for migration demo
                    const topics = [
                      'AWS Migration', 'Database Migration', 'Cloud Architecture', 'DevOps Practices', 
                      'Containerization', 'Microservices', 'Security Best Practices', 'Cost Optimization',
                      'Monitoring and Logging', 'Disaster Recovery', 'Performance Tuning', 'Compliance',
                      'Infrastructure as Code', 'CI/CD Pipelines', 'Serverless Computing', 'Data Analytics'
                    ];
                    
                    const contentTypes = ['BlogPost', 'Page', 'Article', 'Tutorial'];
                    
                    // Insert base data
                    for (const item of baseSampleData) {
                      await dbConnection.execute(
                        'INSERT INTO ContentItems (Title, Summary, Body, ContentType, AuthorId, PublishedDate, ViewCount) VALUES (?, ?, ?, ?, ?, ?, ?)',
                        item
                      );
                    }
                    
                    // Generate 97 additional records (total 100)
                    for (let i = 4; i <= 100; i++) {
                      const topic = topics[Math.floor(Math.random() * topics.length)];
                      const contentType = contentTypes[Math.floor(Math.random() * contentTypes.length)];
                      const viewCount = Math.floor(Math.random() * 200) + 1;
                      const authorId = Math.floor(Math.random() * 3) + 1; // Authors 1-3
                      
                      // Create historic date between 2017-2019
                      const startYear = 2017;
                      const endYear = 2019;
                      const year = startYear + Math.floor(Math.random() * (endYear - startYear + 1));
                      const month = Math.floor(Math.random() * 12);
                      const day = Math.floor(Math.random() * 28) + 1;
                      const publishDate = new Date(year, month, day);
                      
                      const title = `${topic} Guide ${i}`;
                      const summary = `Comprehensive guide covering ${topic.toLowerCase()} best practices and implementation strategies for enterprise applications.`;
                      const body = `<h1>${title}</h1><p>This ${contentType.toLowerCase()} provides detailed insights into ${topic.toLowerCase()} for modern cloud architectures.</p><h2>Key Benefits</h2><ul><li>Improved scalability and performance</li><li>Enhanced security and compliance</li><li>Cost-effective solutions</li><li>Streamlined operations</li></ul><h2>Implementation Strategy</h2><p>Our approach focuses on practical implementation with real-world examples and best practices. This content demonstrates the complexity and richness of data that will be migrated using AWS DMS.</p><p>Content ID: ${i} | Generated for migration workshop demonstration.</p>`;
                      
                      await dbConnection.execute(
                        'INSERT INTO ContentItems (Title, Summary, Body, ContentType, AuthorId, PublishedDate, ViewCount) VALUES (?, ?, ?, ?, ?, ?, ?)',
                        [title, summary, body, contentType, authorId, publishDate, viewCount]
                      );
                    }
                    
                    console.log('Sample data inserted successfully (100 records)');
                  }
                  
                  await dbConnection.end();
                  console.log('Database initialization complete');
                } catch (error) {
                  console.error('Database initialization error:', error);
                }
              }

              app.get('/health', (req, res) => {
                res.json({ 
                  status: 'OK', 
                  phase: process.env.PHASE || 'Phase 1 - Current State',
                  dotnetVersion: process.env.DOTNET_VERSION || '.NET Framework 4.8',
                  deploymentType: process.env.DEPLOYMENT_TYPE || 'CloudFormation Automated',
                  databaseType: 'RDS MySQL 8.0',
                  databaseHost: dbConfig.host,
                  timestamp: new Date().toISOString()
                });
              });

              // View all content items (for migration demo)
              app.get('/all-content', async (req, res) => {
                try {
                  const connection = await mysql.createConnection(dbConfig);
                  
                  // Get all content items
                  const [allPosts] = await connection.execute('SELECT * FROM ContentItems ORDER BY PublishedDate DESC');
                  const totalRecords = allPosts.length;
                  
                  await connection.end();
                  
                  res.send(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>All Content - OrchardLite CMS</title>
                      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                    </head>
                    <body>
                      <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #232F3E;">
                        <div class="container">
                          <a class="navbar-brand text-white" href="/"><i class="fas fa-leaf" style="color: #FF9900;"></i> OrchardLite CMS</a>
                          <div class="navbar-nav ms-auto">
                            <a class="nav-link text-white" href="/"><i class="fas fa-home"></i> Home</a>
                            <span class="badge bg-danger me-2"><i class="fas fa-code"></i> .NET Framework 4.8</span>
                            <span class="badge bg-danger"><i class="fas fa-database"></i> RDS MySQL 8.0</span>
                          </div>
                        </div>
                      </nav>
                      
                      <div class="container mt-4">
                        <div class="alert" style="background-color: #E8F4FD; border-color: #FF9900; color: #232F3E;">
                          <h4><i class="fas fa-list" style="color: #FF9900;"></i> All Content Items (${totalRecords} records)</h4>
                          <p class="mb-0">Complete list of content items for AWS DMS migration demonstration.</p>
                        </div>
                        
                        <div class="row">
                          ${allPosts.map((post, index) => 
                            `<div class="col-md-4 mb-3">
                              <div class="card h-100">
                                <div class="card-body">
                                  <h6 class="card-title">${post.Title}</h6>
                                  <p class="card-text small">${post.Summary || 'No summary available'}</p>
                                  <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                      <i class="fas fa-calendar"></i> ${new Date(post.PublishedDate).toLocaleDateString()}
                                    </small>
                                    <small class="text-muted">
                                      <span class="badge bg-secondary">${post.ContentType}</span>
                                      <i class="fas fa-eye ms-1"></i> ${post.ViewCount}
                                    </small>
                                  </div>
                                </div>
                              </div>
                            </div>`
                          ).join('')}
                        </div>
                        
                        <div class="mt-4 text-center">
                          <a href="/" class="btn" style="background-color: #232F3E; border-color: #232F3E; color: white;"><i class="fas fa-arrow-left"></i> Back to Home</a>
                        </div>
                      </div>
                      
                      <footer class="mt-5 py-3" style="background-color: #F2F3F3;">
                        <div class="container text-center">
                          <small class="text-muted">
                            OrchardLite CMS - Migration Demo | 
                            <i class="fas fa-database"></i> ${totalRecords} Total Records | 
                            <i class="fas fa-server"></i> Ready for AWS DMS
                          </small>
                        </div>
                      </footer>
                    </body>
                    </html>
                  `);
                } catch (error) {
                  console.error('Error fetching all content:', error);
                  res.status(500).send(`
                    <div class="container mt-4">
                      <div class="alert alert-danger">
                        <h1><i class="fas fa-exclamation-triangle"></i> Error Loading Content</h1>
                        <p><strong>Error:</strong> ${error.message}</p>
                      </div>
                    </div>
                  `);
                }
              });

              app.get('/', async (req, res) => {
                try {
                  const connection = await mysql.createConnection(dbConfig);
                  
                  // Get total record count
                  const [countResult] = await connection.execute('SELECT COUNT(*) as total FROM ContentItems');
                  const totalRecords = countResult[0].total;
                  
                  // Get recent posts (show more for migration demo)
                  const [posts] = await connection.execute('SELECT * FROM ContentItems ORDER BY PublishedDate DESC LIMIT 20');
                  
                  await connection.end();
                  
                  res.send(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>OrchardLite CMS - Enterprise Content Management</title>
                      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                      <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                    </head>
                    <body>
                      <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #232F3E;">
                        <div class="container">
                          <a class="navbar-brand text-white" href="/"><i class="fas fa-leaf" style="color: #FF9900;"></i> OrchardLite CMS</a>
                          <div class="navbar-nav ms-auto">
                            <span class="badge bg-danger me-2"><i class="fas fa-code"></i> .NET Framework 4.8</span>
                            <span class="badge bg-danger"><i class="fas fa-database"></i> RDS MySQL 8.0</span>
                          </div>
                        </div>
                      </nav>
                      
                      <div class="container mt-4">
                        <div class="alert" style="background-color: #E8F4FD; border-color: #FF9900; color: #232F3E;">
                          <h4><i class="fas fa-info-circle" style="color: #FF9900;"></i> Application Deployment Complete</h4>
                          <p class="mb-0"><strong>Status:</strong> Enterprise CMS running on <span class="text-danger">.NET Framework 4.8</span> with <span class="text-danger">RDS MySQL 8.0</span> database on AWS cloud infrastructure.</p>
                        </div>
                        
                        <div class="row">
                          <div class="col-md-8">
                            <h1>Welcome to OrchardLite CMS</h1>
                            <p class="lead">Enterprise Content Management System</p>
                            
                            <div class="alert alert-success">
                              <h5><i class="fas fa-check-circle"></i> Database Connected</h5>
                              <p><strong>Database:</strong> ${dbConfig.host}:${dbConfig.port}</p>
                              <p><strong>Total Records:</strong> ${totalRecords}</p>
                              <p><strong>Platform:</strong> ECS Fargate</p>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3">
                              <h3>Content Items</h3>
                              <a href="/all-content" class="btn btn-sm" style="background-color: #FF9900; border-color: #FF9900; color: white;">
                                <i class="fas fa-list"></i> View All ${totalRecords} Records
                              </a>
                            </div>
                            <div class="row">
                              ${posts.map((post, index) => 
                                `<div class="col-md-6 mb-3">
                                  <div class="card">
                                    <div class="card-body">
                                      <h6 class="card-title">${post.Title}</h6>
                                      <p class="card-text small">${post.Summary || 'No summary available'}</p>
                                      <small class="text-muted">
                                        <i class="fas fa-calendar"></i> ${new Date(post.PublishedDate).toLocaleDateString()}
                                        <i class="fas fa-eye ms-2"></i> ${post.ViewCount}
                                      </small>
                                    </div>
                                  </div>
                                </div>`
                              ).join('')}
                            </div>
                            <div class="text-center mt-3">
                              <small class="text-muted">Showing latest 20 of ${totalRecords} total records</small>
                            </div>
                          </div>
                          
                          <div class="col-md-4">
                            <div class="card">
                              <div class="card-header text-white" style="background-color: #232F3E;">
                                <h5><i class="fas fa-info-circle" style="color: #FF9900;"></i> System Information</h5>
                              </div>
                              <div class="card-body">
                                <ul class="list-unstyled">
                                  <li><strong>Framework:</strong> <span class="text-danger">.NET Framework 4.8</span></li>
                                  <li><strong>Platform:</strong> ECS Fargate</li>
                                  <li><strong>Database:</strong> <span class="text-danger">RDS MySQL 8.0</span></li>
                                  <li><strong>Deployment:</strong> CloudFormation</li>
                                  <li><strong>Deployment:</strong> CloudFormation</li>
                                  <li><strong>Records:</strong> ${totalRecords}</li>
                                </ul>
                              </div>
                            </div>
                            
                            <div class="card mt-3">
                              <div class="card-header text-white" style="background-color: #FF9900;">
                                <h5><i class="fas fa-check-circle"></i> Setup Complete</h5>
                              </div>
                              <div class="card-body">
                                <ul class="list-unstyled">
                                  <li><i class="fas fa-check text-success"></i> RDS MySQL Database</li>
                                  <li><i class="fas fa-check text-success"></i> ECS Fargate Application</li>
                                  <li><i class="fas fa-check text-success"></i> Load Balancer & Networking</li>
                                  <li><i class="fas fa-check text-success"></i> Sample Data Created</li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <footer class="mt-5 py-3" style="background-color: #F2F3F3;">
                        <div class="container text-center">
                          <small class="text-muted">
                            OrchardLite CMS - Enterprise Content Management | 
                            <i class="fas fa-code"></i> <span class="text-danger">.NET Framework 4.8</span> | 
                            <i class="fas fa-database"></i> <span class="text-danger">RDS MySQL 8.0</span> | 
                            <i class="fas fa-server"></i> ${totalRecords} Records
                          </small>
                        </div>
                      </footer>
                    </body>
                    </html>
                  `);
                } catch (error) {
                  console.error('Database error:', error);
                  res.status(500).send(`
                    <div class="container mt-4">
                      <div class="alert alert-danger">
                        <h1><i class="fas fa-exclamation-triangle"></i> Database Connection Error</h1>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Database Host:</strong> ${dbConfig.host}</p>
                        <p><strong>Phase:</strong> ${process.env.PHASE}</p>
                      </div>
                    </div>
                  `);
                }
              });

              // Initialize database and start server
              initializeDatabase().then(() => {
                app.listen(serverPort, '0.0.0.0', () => {
                  console.log(`OrchardLite CMS Enterprise (.NET Framework 4.8) running on port ${serverPort}`);
                  console.log('Database Host:', dbConfig.host);
                  console.log('Application Deployment Complete');
                });
              }).catch(error => {
                console.error('Failed to initialize database:', error);
                process.exit(1);
              });
              EOF
              npm start
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref ECSLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  # ECS Service
  ECSService:
    Type: AWS::ECS::Service
    DependsOn: ALBListener
    Properties:
      ServiceName: orchardlite-prestage-service
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref ECSTaskDefinition
      LaunchType: FARGATE
      DesiredCount: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          SecurityGroups:
            - !Ref ECSSecurityGroup
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
          AssignPublicIp: DISABLED
      LoadBalancers:
        - ContainerName: orchardlite-prestage-app
          ContainerPort: 8080
          TargetGroupArn: !Ref ALBTargetGroup
      HealthCheckGracePeriodSeconds: 300

Outputs:
  ApplicationURL:
    Description: URL of the OrchardLite CMS Prestage Application
    Value: !Sub "http://${ApplicationLoadBalancer.DNSName}"

  LoadBalancerDNS:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  DatabaseEndpoint:
    Description: RDS MySQL database endpoint
    Value: !GetAtt RDSDatabase.Endpoint.Address

  ECSClusterName:
    Description: Name of the ECS Cluster
    Value: !Ref ECSCluster

  WorkshopPhase:
    Description: Current workshop phase
    Value: "Phase 1 - Prestage Setup (.NET Framework 4.8 + RDS MySQL)"
